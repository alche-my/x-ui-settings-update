# 🔍 Диагностический скрипт для Dokodemo-door Bridge

<div align="center">

**Комплексный инструмент диагностики для выявления проблем с Dokodemo-door мостом в 3x-ui**

[![Version](https://img.shields.io/badge/version-1.0.0-blue.svg)](https://github.com/alche-my/x-ui-settings-update)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)
[![Bash](https://img.shields.io/badge/bash-5.0%2B-orange.svg)](https://www.gnu.org/software/bash/)

[Быстрый старт](#-быстрый-запуск) •
[Что проверяет](#-что-проверяет-скрипт) •
[Примеры использования](#-примеры-использования) •
[Troubleshooting](#-исправление-типичных-проблем) •
[FAQ](#-faq)

</div>

---

## 📖 Оглавление

- [О скрипте](#-о-скрипте)
- [Быстрый запуск](#-быстрый-запуск)
- [Что проверяет скрипт](#-что-проверяет-скрипт)
- [Примеры использования](#-примеры-использования)
- [Пример вывода](#-пример-вывода)
- [Когда использовать](#-когда-использовать)
- [Исправление типичных проблем](#-исправление-типичных-проблем)
- [Интерпретация результатов](#-интерпретация-результатов)
- [Расширенная диагностика](#-расширенная-диагностика)
- [FAQ](#-faq)

---

## 🎯 О скрипте

Этот диагностический инструмент проводит **11 категорий проверок** вашего Dokodemo-door моста, автоматически выявляет проблемы и предоставляет конкретные рекомендации по их устранению.

### Зачем нужен этот скрипт?

- ✅ **Быстрая диагностика** - проверка за 30 секунд
- 🔍 **Всесторонний анализ** - от системных ресурсов до сетевых соединений
- 💡 **Автоматические рекомендации** - скрипт сам подскажет что исправить
- 📊 **Наглядный отчет** - цветной вывод с подсчетом проблем
- 🚀 **Без установки** - запуск одной командой

---

## 🚀 Быстрый запуск

### ⚡ Запуск одной командой (рекомендуется)

На вашем российском VPS выполните:

```bash
bash <(curl -Ls https://raw.githubusercontent.com/alche-my/x-ui-settings-update/main/diagnose-dokodemo-bridge.sh)
```

### 📥 Локальный запуск

Если хотите сохранить скрипт локально:

```bash
# Скачать
wget https://raw.githubusercontent.com/alche-my/x-ui-settings-update/main/diagnose-dokodemo-bridge.sh

# Сделать исполняемым
chmod +x diagnose-dokodemo-bridge.sh

# Запустить
sudo ./diagnose-dokodemo-bridge.sh
```

### 📝 Сохранить результат в файл

```bash
# С временной меткой
sudo bash diagnose-dokodemo-bridge.sh | tee diagnostic-$(date +%Y%m%d-%H%M%S).txt

# Простой вариант
sudo bash diagnose-dokodemo-bridge.sh > diagnostic-report.txt 2>&1
```

---

## 📋 Что проверяет скрипт

### 1. Права доступа
- ✅ Запущен ли скрипт с правами root

### 2. Зависимости
- ✅ jq, curl, ss, netstat, ping, nc, traceroute
- 📦 Показывает какие пакеты отсутствуют

### 3. Системные ресурсы
- 💾 Место на диске
- 🧠 Использование памяти
- 📊 Load average

### 4. Сервис x-ui
- ✅ x-ui установлен
- ✅ Сервис активен и включен
- ✅ Процесс Xray запущен
- 🆔 PID процесса

### 5. Конфигурация Xray
- ✅ Файл config.json существует
- ✅ JSON валиден
- ✅ DNS настроен
- ✅ Dokodemo inbound'ы присутствуют
- ⚠️ Нет дублирования inbound'ов
- 📝 Детали каждого inbound'а

### 6. База данных x-ui
- ✅ БД существует
- ✅ Dokodemo inbound'ы в БД
- 📊 Статус каждого inbound'а (включен/выключен)

### 7. Сетевые порты
- ✅ Dokodemo порты слушаются
- 🔌 Список открытых портов

### 8. Firewall
- ✅ Статус UFW
- ✅ Порты разрешены в firewall
- 📋 Количество правил iptables

### 9. Доступность финских серверов
- 🏓 Ping тест к каждому серверу
- 🔗 TCP соединение на порт 443
- 🌐 Проверка всех настроенных серверов

### 10. Логи x-ui
- 📜 Поиск ошибок за последние 10 минут
- ⚠️ Обнаружение частых перезапусков
- 📄 Показ последних ошибок

### 11. Внешний IP
- 🌍 Определение внешнего IP моста
- 💡 IP для использования в клиентских конфигах

---

## 💼 Примеры использования

### Сценарий 1: После установки моста

```bash
# Проверить что всё настроено правильно
sudo bash diagnose-dokodemo-bridge.sh

# Ожидаемый результат:
# ✓ Проверок пройдено: 28+
# ⚠ Предупреждений: 0-2
# ✗ Ошибок: 0
```

### Сценарий 2: Пользователь не может подключиться

```bash
# Запустить диагностику и сохранить отчет
sudo bash diagnose-dokodemo-bridge.sh | tee problem-report.txt

# Посмотреть секцию "Обнаруженные проблемы"
# Следовать рекомендациям
```

### Сценарий 3: Регулярный мониторинг

```bash
# Добавить в cron для еженедельной проверки
crontab -e

# Добавить строку (каждое воскресенье в 3:00)
0 3 * * 0 /root/diagnose-dokodemo-bridge.sh > /var/log/dokodemo-weekly-check.log 2>&1
```

### Сценарий 4: Отправка отчета в поддержку

```bash
# Создать детальный отчет с временной меткой
sudo bash diagnose-dokodemo-bridge.sh > diagnostic-$(hostname)-$(date +%Y%m%d-%H%M%S).txt 2>&1

# Отправить файл diagnostic-*.txt в поддержку
```

### Сценарий 5: Быстрая проверка перед обновлением

```bash
# Перед обновлением x-ui или системы
sudo bash diagnose-dokodemo-bridge.sh

# Убедиться что всё работает
# Затем делать обновление

# После обновления
sudo bash diagnose-dokodemo-bridge.sh

# Сравнить результаты
```

---

## 📊 Пример вывода

```
╔════════════════════════════════════════════════════════════════╗
║     Dokodemo-door Bridge Diagnostic Tool                      ║
║     Version: 1.0.0                                             ║
╚════════════════════════════════════════════════════════════════╝

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. Проверка прав доступа
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Скрипт запущен с правами root

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
2. Проверка зависимостей
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ jq установлен
✓ curl установлен
✓ ss установлен
⚠ nc не установлен (опционально)

...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ИТОГОВЫЙ ОТЧЕТ

✓ Проверок пройдено: 25
⚠ Предупреждений: 3
✗ Ошибок: 1

✗ ОБНАРУЖЕНЫ ПРОБЛЕМЫ Требуется исправление.

Обнаруженные проблемы:
  ✗ Порт 443 не открыт

Рекомендации по исправлению:
  1. Проверьте что x-ui запущен и inbound включен
  2. Откройте порт: ufw allow 443/tcp && ufw allow 443/udp

Быстрые команды для исправления:
  # Перезапуск x-ui:
  systemctl restart x-ui

  # Просмотр логов:
  journalctl -u x-ui -f

  # Проверка портов:
  ss -tlnp | grep -E ':443|:8443'
```

## 🎯 Когда использовать

### Сразу после установки
Проверьте что всё настроено правильно:
```bash
sudo bash diagnose-dokodemo-bridge.sh
```

### Если пользователь не может подключиться
Диагностируйте проблему:
```bash
sudo bash diagnose-dokodemo-bridge.sh > diagnostic-report.txt
# Отправьте diagnostic-report.txt для анализа
```

### Регулярная проверка
Проверяйте состояние моста периодически:
```bash
# Добавить в cron для ежедневной проверки
0 3 * * * /root/diagnose-dokodemo-bridge.sh > /var/log/dokodemo-check.log 2>&1
```

### Перед обращением в поддержку
Соберите диагностическую информацию:
```bash
sudo bash diagnose-dokodemo-bridge.sh | tee diagnostic-$(date +%Y%m%d-%H%M%S).txt
```

## 🔧 Исправление типичных проблем

### Проблема: Порты не слушаются
```bash
# Решение 1: Перезапустить x-ui
systemctl restart x-ui

# Решение 2: Проверить включены ли inbound'ы в панели
# Зайдите в панель и включите Dokodemo inbound'ы
```

### Проблема: DNS не настроен
```bash
# Решение: Запустить setup скрипт заново
bash <(curl -Ls https://raw.githubusercontent.com/alche-my/x-ui-settings-update/main/setup-dokodemo-bridge.sh)
```

### Проблема: Финский сервер недоступен
```bash
# Проверить доступность вручную
ping -c 3 217.144.189.220
nc -zv 217.144.189.220 443

# Если недоступен - проблема на стороне финского сервера
```

### Проблема: Много ошибок в логах
```bash
# Смотреть логи в реальном времени
journalctl -u x-ui -f

# Искать конкретные ошибки
journalctl -u x-ui --since today | grep ERROR
```

### Проблема: Firewall блокирует порты
```bash
# Открыть порты в UFW
ufw allow 443/tcp
ufw allow 443/udp
ufw allow 8443/tcp
ufw allow 8443/udp
ufw reload

# Проверить
ufw status
```

## 📈 Интерпретация результатов

### ✓ Всё отлично (0 ошибок, 0-2 предупреждения)
Мост работает корректно. Можно подключать пользователей.

### ⚠ Есть предупреждения (0 ошибок, 3+ предупреждений)
Мост работает, но есть потенциальные проблемы. Рекомендуется исправить.

### ✗ Есть ошибки (1+ ошибок)
Мост не работает или работает некорректно. **Требуется исправление**.

## 🔍 Расширенная диагностика

### Проверить конкретный порт
```bash
# Слушается ли порт
ss -tlnp | grep :443

# Доступен ли снаружи (с другого сервера)
nc -zv YOUR_IP 443
```

### Проверить маршрутизацию до финского сервера
```bash
traceroute 217.144.189.220
mtr -r -c 10 217.144.189.220
```

### Проверить DNS резолвинг
```bash
# На сервере
dig @1.1.1.1 google.com
nslookup google.com 8.8.8.8
```

### Мониторинг трафика
```bash
# Смотреть трафик на Dokodemo портах
tcpdump -i any port 443 -n
```

## 🎨 Цветовая кодировка вывода

Скрипт использует цветовую кодировку для упрощения анализа:

| Символ | Цвет | Значение | Действие |
|--------|------|----------|----------|
| ✓ | 🟢 Зеленый | Проверка пройдена | Всё в порядке |
| ⚠ | 🟡 Желтый | Предупреждение | Рекомендуется исправить |
| ✗ | 🔴 Красный | Ошибка | Требуется исправление |
| ℹ | 🔵 Синий | Информация | Справочная информация |

### Общий статус

| Результат | Интерпретация |
|-----------|---------------|
| **✓ ВСЁ ОТЛИЧНО!** | 0 ошибок, 0-2 предупреждения. Мост работает идеально |
| **⚠ ЕСТЬ ПРЕДУПРЕЖДЕНИЯ** | 0 ошибок, 3+ предупреждений. Работает, но есть рекомендации |
| **✗ ОБНАРУЖЕНЫ ПРОБЛЕМЫ** | 1+ ошибок. Требуется немедленное исправление |

---

## ❓ FAQ

### Общие вопросы

<details>
<summary><b>Q: Скрипт показывает ошибку "Требуются права root"</b></summary>

**A:** Запускайте с sudo:
```bash
sudo bash diagnose-dokodemo-bridge.sh
```
</details>

<details>
<summary><b>Q: Много предупреждений про отсутствующие пакеты</b></summary>

**A:** Установите недостающие пакеты:
```bash
apt-get install -y jq curl netcat-openbsd dnsutils traceroute
```

Скрипт будет работать и без них, но с ограниченной функциональностью.
</details>

<details>
<summary><b>Q: Скрипт не может подключиться к финскому серверу</b></summary>

**A:** Возможные причины:
1. Финский сервер выключен или перезагружается
2. Блокировка файрволом на финском сервере
3. Проблемы с маршрутизацией

Проверьте вручную:
```bash
ping -c 3 YOUR_FINNISH_IP
nc -zv YOUR_FINNISH_IP 443
```
</details>

<details>
<summary><b>Q: Показывает дублирующиеся inbound'ы</b></summary>

**A:** Это происходит когда inbound'ы есть и в БД и в config.json.

Решение:
1. Зайдите в панель x-ui (http://YOUR_IP:2053)
2. Удалите дублирующиеся Dokodemo inbound'ы
3. Перезапустите x-ui: `systemctl restart x-ui`
</details>

<details>
<summary><b>Q: Как сохранить результат диагностики?</b></summary>

**A:** Используйте перенаправление вывода:
```bash
# Простой способ
sudo bash diagnose-dokodemo-bridge.sh > report.txt 2>&1

# С отображением на экране
sudo bash diagnose-dokodemo-bridge.sh | tee report.txt

# С временной меткой
sudo bash diagnose-dokodemo-bridge.sh > diagnostic-$(date +%Y%m%d-%H%M%S).txt 2>&1
```
</details>

<details>
<summary><b>Q: Можно ли запускать скрипт удаленно?</b></summary>

**A:** Да, через SSH:
```bash
ssh root@YOUR_SERVER_IP "bash <(curl -Ls https://raw.githubusercontent.com/.../diagnose-dokodemo-bridge.sh)"
```
</details>

<details>
<summary><b>Q: Скрипт влияет на работу моста?</b></summary>

**A:** Нет, скрипт только **читает** конфигурацию и проверяет состояние. Он **не вносит никаких изменений**.
</details>

<details>
<summary><b>Q: Как часто нужно запускать диагностику?</b></summary>

**A:** Рекомендации:
- 🔴 **Сразу после установки** - обязательно
- 🟡 **При проблемах** - каждый раз
- 🟢 **Профилактически** - раз в неделю/месяц
- 🔵 **Перед обновлениями** - обязательно
</details>

### Технические вопросы

<details>
<summary><b>Q: Что означает "DNS конфигурация отсутствует"?</b></summary>

**A:** В config.json нет секции `dns` или она пустая. Это может вызывать проблемы с резолвингом доменов.

Решение: Запустите setup-dokodemo-bridge.sh заново - он автоматически добавит DNS.
</details>

<details>
<summary><b>Q: Порты показываются как "не слушаются", но x-ui запущен</b></summary>

**A:** Возможные причины:
1. Inbound выключен в панели x-ui
2. x-ui перезапускается из-за ошибок конфигурации
3. Конфликт портов с другими сервисами

Проверьте:
```bash
ss -tlnp | grep -E ':443|:8443'
journalctl -u x-ui -n 50
```
</details>

<details>
<summary><b>Q: В логах много ошибок "existing tag found"</b></summary>

**A:** Это дублирование inbound'ов. x-ui пытается добавить из БД inbound'ы, которые уже есть в config.json.

Не критично если в итоге Xray запускается, но лучше исправить - удалить дубликаты.
</details>

## 🔗 Связанные инструменты

- [setup-dokodemo-bridge.sh](README-dokodemo-bridge.md) - Основной скрипт установки
- [config.example.json](config.example.json) - Пример конфигурации

## 📝 Лицензия

MIT License

---

**Полезно?** Поставьте звезду ⭐ на [GitHub](https://github.com/alche-my/x-ui-settings-update)!
