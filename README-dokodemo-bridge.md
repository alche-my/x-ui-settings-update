# Dokodemo-door Bridge Setup Script for 3x-ui

Автоматический скрипт для настройки российского VPS в качестве "моста" (bridge) для обхода блокировок с использованием протокола Dokodemo-door в 3x-ui.

## Описание

Этот скрипт автоматизирует процесс создания туннелей между вашим российским VPS и финскими серверами, позволяя клиентам подключаться через российский IP, в то время как трафик прозрачно пересылается на финские серверы.

### Архитектура

```
Клиент (Reality/VLESS) → Российский VPS (Dokodemo) → Финский VPS (3x-ui Reality) → Интернет
```

### Что делает скрипт

1. ✅ Проверяет наличие 3x-ui и предлагает установить при необходимости
2. ✅ Интерактивно собирает данные о ваших финских серверах
3. ✅ Валидирует все введенные данные (IP, порты, названия)
4. ✅ Автоматически создает Dokodemo-door inbound'ы через API 3x-ui
5. ✅ Выводит детальную итоговую информацию о настройках

## Требования

### Операционные системы

- Ubuntu 20.04 / 22.04
- Debian 10 / 11
- CentOS 7 / 8

### Зависимости

Скрипт автоматически установит следующие пакеты при необходимости:

- `curl` - для HTTP запросов
- `jq` - для обработки JSON

### Права доступа

Скрипт должен быть запущен с правами root (используйте `sudo`).

## Установка

### Быстрый старт

```bash
# Скачать скрипт
wget https://raw.githubusercontent.com/alche-my/x-ui-settings-update/main/setup-dokodemo-bridge.sh

# Сделать исполняемым
chmod +x setup-dokodemo-bridge.sh

# Запустить
sudo ./setup-dokodemo-bridge.sh
```

### С использованием git

```bash
git clone https://github.com/alche-my/x-ui-settings-update.git
cd x-ui-settings-update
chmod +x setup-dokodemo-bridge.sh
sudo ./setup-dokodemo-bridge.sh
```

## Использование

### Интерактивный режим

Просто запустите скрипт без параметров:

```bash
sudo ./setup-dokodemo-bridge.sh
```

Скрипт последовательно запросит:

1. **Количество серверов** (1-20)
2. **Для каждого сервера:**
   - Название/описание (например: Finland-Helsinki-1)
   - IP-адрес финского сервера
   - Порт на финском сервере (обычно 443)
   - Порт для прослушивания на российском VPS
3. **Данные для доступа к 3x-ui API:**
   - URL панели (по умолчанию: http://localhost:2053)
   - Логин администратора (по умолчанию: admin)
   - Пароль администратора

### Режим конфигурационного файла

Для автоматической настройки без интерактивного ввода:

```bash
sudo ./setup-dokodemo-bridge.sh --config config.json
```

Пример конфигурационного файла см. в [config.example.json](config.example.json).

## Примеры

### Пример 1: Один сервер

```
Сколько финских серверов нужно настроить? (1-20): 1

=== Настройка сервера #1 ===
Название/описание: Finland-Helsinki
IP-адрес финского сервера: 95.217.123.45
Порт на финском сервере: 443
Порт для прослушивания на этом VPS: 443

=== Настройка доступа к 3x-ui ===
URL панели 3x-ui: [Enter для http://localhost:2053]
Логин администратора: [Enter для admin]
Пароль администратора: ********
```

### Пример 2: Несколько серверов

```
Сколько финских серверов нужно настроить? (1-20): 3

=== Настройка сервера #1 ===
Название/описание: Finland-Helsinki-1
IP-адрес финского сервера: 95.217.123.45
Порт на финском сервере: 443
Порт для прослушивания на этом VPS: 443

=== Настройка сервера #2 ===
Название/описание: Finland-Amsterdam-1
IP-адрес финского сервера: 95.217.123.46
Порт на финском сервере: 443
Порт для прослушивания на этом VPS: 8443

=== Настройка сервера #3 ===
Название/описание: Finland-Frankfurt-1
IP-адрес финского сервера: 95.217.123.47
Порт на финском сервере: 443
Порт для прослушивания на этом VPS: 2053
```

## Итоговый вывод

После успешной настройки скрипт выведет детальную информацию:

```
=== Настройка завершена ===

Создано инбаундов: 3 из 3

Сервер #1: Finland-Helsinki-1
  - Локальный порт: 443
  - Перенаправление: 95.217.123.45:443
  - Статус: ✓ Успешно создан

Сервер #2: Finland-Amsterdam-1
  - Локальный порт: 8443
  - Перенаправление: 95.217.123.46:443
  - Статус: ✓ Успешно создан

Сервер #3: Finland-Frankfurt-1
  - Локальный порт: 2053
  - Перенаправление: 95.217.123.47:443
  - Статус: ✓ Успешно создан

=== IP этого моста ===
Внешний IP: 5.5.5.5

Для обновления клиентских конфигов замените:
  - Старый IP финского сервера → 5.5.5.5
  - Старый порт → соответствующий порт из таблицы выше

Панель управления 3x-ui: http://5.5.5.5:2053
```

## Настройка клиентов

После успешной настройки моста обновите конфигурации ваших клиентов:

### Что изменить в клиентских конфигах

1. **IP-адрес сервера:** Замените IP финского сервера на IP российского VPS (моста)
2. **Порт:** Замените порт на соответствующий локальный порт из таблицы выше
3. **Остальные параметры:** Оставьте без изменений (UUID, Flow, Security и т.д.)

### Пример (V2RayN, Nekoray, и др.)

**До:**
```
Address: 95.217.123.45
Port: 443
UUID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
Flow: xtls-rprx-vision
Security: reality
```

**После:**
```
Address: 5.5.5.5  ← IP российского моста
Port: 443         ← Локальный порт из конфигурации
UUID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx  ← без изменений
Flow: xtls-rprx-vision                       ← без изменений
Security: reality                            ← без изменений
```

## Устранение неполадок

### Скрипт не может найти 3x-ui

**Проблема:** Скрипт сообщает, что 3x-ui не установлен, хотя вы уверены, что он установлен.

**Решение:**
- Проверьте наличие директории: `ls -la /usr/local/x-ui/`
- Проверьте процесс: `ps aux | grep x-ui`
- Убедитесь, что сервис запущен: `systemctl status x-ui`

### Ошибка аутентификации в API

**Проблема:** `Ошибка аутентификации (HTTP 401)`

**Решение:**
- Проверьте правильность логина и пароля
- Убедитесь, что URL панели правильный
- Проверьте доступность панели: `curl http://localhost:2053`
- Проверьте, что 3x-ui запущен: `systemctl status x-ui`

### Порт уже используется

**Проблема:** API возвращает ошибку о том, что порт занят.

**Решение:**
- Проверьте существующие inbound'ы в панели 3x-ui
- Используйте другой свободный порт
- Удалите конфликтующий inbound через панель 3x-ui

### Не удается подключиться с клиента

**Проблема:** После настройки моста клиент не может подключиться.

**Решение:**
1. Проверьте firewall на российском VPS:
   ```bash
   # Для Ubuntu/Debian
   sudo ufw allow 443/tcp
   sudo ufw allow 8443/tcp

   # Для CentOS
   sudo firewall-cmd --permanent --add-port=443/tcp
   sudo firewall-cmd --permanent --add-port=8443/tcp
   sudo firewall-cmd --reload
   ```

2. Проверьте доступность портов:
   ```bash
   # Проверка, что 3x-ui слушает порт
   netstat -tlnp | grep 443
   ```

3. Проверьте логи 3x-ui:
   ```bash
   journalctl -u x-ui -f
   ```

4. Убедитесь, что финский сервер доступен:
   ```bash
   telnet 95.217.123.45 443
   # или
   nc -zv 95.217.123.45 443
   ```

### Ошибка "File name too long"

**Проблема:** При выполнении команд возникает ошибка о слишком длинном имени файла.

**Решение:** Эта проблема исправлена в скрипте. Если она все еще возникает, убедитесь, что используете последнюю версию скрипта.

## Безопасность

### Рекомендации по безопасности

1. **Смените пароль 3x-ui по умолчанию** сразу после установки:
   - Зайдите в панель 3x-ui
   - Перейдите в настройки
   - Смените логин и пароль администратора

2. **Ограничьте доступ к панели 3x-ui:**
   ```bash
   # Разрешить доступ только с вашего IP
   sudo ufw allow from YOUR_IP to any port 2053
   ```

3. **Используйте HTTPS для панели:** Настройте SSL-сертификат для веб-панели 3x-ui

4. **Регулярно обновляйте:** Держите 3x-ui и систему в актуальном состоянии

## Дополнительные команды

### Проверка статуса 3x-ui

```bash
systemctl status x-ui
```

### Перезапуск 3x-ui

```bash
systemctl restart x-ui
```

### Просмотр логов

```bash
journalctl -u x-ui -f
```

### Управление 3x-ui

```bash
x-ui
```

Эта команда откроет меню управления 3x-ui с опциями:
- Запуск/остановка/перезапуск
- Просмотр логов
- Обновление
- И другие опции

## Технические детали

### Что такое Dokodemo-door

Dokodemo-door (どこでもドア, "Дверь в любое место") - это протокол в Xray, который прозрачно пересылает весь входящий трафик на указанный адрес и порт без изменения содержимого пакетов.

### Структура создаваемого inbound'а

```json
{
  "enable": true,
  "remark": "Dokodemo -> Finland-Helsinki-1",
  "listen": "0.0.0.0",
  "port": 443,
  "protocol": "dokodemo-door",
  "settings": {
    "address": "95.217.123.45",
    "port": 443,
    "network": "tcp,udp"
  },
  "streamSettings": {
    "network": "tcp",
    "security": "none"
  },
  "sniffing": {
    "enabled": true,
    "destOverride": ["http", "tls"]
  }
}
```

### API Endpoints

Скрипт использует следующие API endpoints 3x-ui:

- `POST /login` - Аутентификация
- `POST /panel/api/inbounds/add` - Создание inbound'а
- `GET /panel/api/inbounds/list` - Список inbound'ов (не используется, но доступен)

## FAQ

**Q: Можно ли использовать скрипт несколько раз?**
A: Да, но учтите, что порты должны быть уникальными. Скрипт не удаляет существующие inbound'ы.

**Q: Как удалить созданные inbound'ы?**
A: Через веб-панель 3x-ui или через API endpoint `/panel/api/inbounds/del/:id`

**Q: Можно ли использовать IPv6?**
A: Да, скрипт поддерживает как IPv4, так и IPv6 адреса.

**Q: Работает ли скрипт с другими панелями (x-ui, v2-ui)?**
A: Скрипт разработан специально для 3x-ui. Для других панелей может потребоваться адаптация API запросов.

**Q: Что будет, если финский сервер недоступен?**
A: Inbound создастся успешно, но клиенты не смогут подключиться. Dokodemo-door просто попытается переслать трафик на недоступный адрес.

**Q: Нужно ли открывать порты в firewall?**
A: Да, убедитесь, что порты прослушивания открыты во входящих правилах firewall.

## Поддержка

Если у вас возникли проблемы или вопросы:

1. Проверьте раздел [Устранение неполадок](#устранение-неполадок)
2. Проверьте логи: `journalctl -u x-ui -f`
3. Откройте issue на GitHub: https://github.com/alche-my/x-ui-settings-update/issues

## Лицензия

MIT License - свободно используйте, модифицируйте и распространяйте.

## Changelog

### Version 1.0.0 (2025-10-29)
- Первый релиз
- Интерактивная настройка серверов
- Автоматическая установка 3x-ui
- Создание Dokodemo-door inbound'ов
- Валидация всех вводимых данных
- Цветной вывод с подробной информацией
- Поддержка конфигурационных файлов

## Авторы

Разработано для упрощения настройки Dokodemo-door мостов на российских VPS.

---

**Примечание:** Этот инструмент предназначен для легального использования в целях обхода технических ограничений доступа к информации. Убедитесь, что вы соблюдаете законодательство вашей страны.
