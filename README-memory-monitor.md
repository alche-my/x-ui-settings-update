# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –ø–∞–º—è—Ç–∏ Dokodemo-—Å–µ—Ä–≤–µ—Ä–∞

## üîç –ü—Ä–æ–±–ª–µ–º–∞

Dokodemo-door —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –ø–∞–º—è—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∏—á–∏–Ω–∞–º:

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏:

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ timeout –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**
   - Dokodemo-door –¥–µ—Ä–∂–∏—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ –¥–æ–ª–≥–æ
   - "–ú–µ—Ä—Ç–≤—ã–µ" —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –∏ –∑–∞–Ω–∏–º–∞—é—Ç –ø–∞–º—è—Ç—å

2. **–ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**
   - –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–∞–º—è—Ç—å —Ä–∞—Å—Ç–µ—Ç –ª–∏–Ω–µ–π–Ω–æ
   - –°—Ç–∞—Ä—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

3. **–§—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–∞–∫–µ—Ç–æ–≤ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω tuning level-1/2)**
   - Level 1: —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã 100-200 –±–∞–π—Ç, –∏–Ω—Ç–µ—Ä–≤–∞–ª 10-20 –º—Å
   - Level 2: —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã 50-150 –±–∞–π—Ç, –∏–Ω—Ç–µ—Ä–≤–∞–ª 5-15 –º—Å (–±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ)
   - –ö–∞–∂–¥—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –±—É—Ñ–µ—Ä –≤ –ø–∞–º—è—Ç–∏

4. **–î–æ–ª–≥–æ–∂–∏–≤—É—â–∏–µ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è**
   - WebSocket –∏ HTTP/2 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –∂–∏—Ç—å —á–∞—Å–∞–º–∏
   - –ë–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ tcpKeepAlive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ –æ—á–∏—â–∞—é—Ç—Å—è

## üí° –†–µ—à–µ–Ω–∏–µ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç `monitor-memory.sh` —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –ø–∞–º—è—Ç–∏ **–±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–≤—è–∑–∏**:

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ Xray** (–Ω–µ —Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º—ã)
‚úÖ **Graceful restart –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞** (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç restart-loop** (–º–∞–∫—Å–∏–º—É–º 6 —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤ –≤ —á–∞—Å)
‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π** –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º
‚úÖ **–ò—Å—Ç–æ—Ä–∏—è —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ cron/systemd**

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –°–∫–∞—á–∞—Ç—å —Å–∫—Ä–∏–ø—Ç

```bash
cd /home/user/x-ui-settings-update
chmod +x monitor-memory.sh
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–∞–º—è—Ç–∏
sudo ./monitor-memory.sh status
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
Xray Process Status:
  PID: 12345
  Memory: 450MB / 2048MB (22%)
  Threshold: 80%
  Status: ‚úì OK
```

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–∞–º—è—Ç–∏
sudo ./monitor-memory.sh status

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–¥–∏–Ω —Ä–∞–∑ (—Å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
sudo ./monitor-memory.sh monitor

# –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤
./monitor-memory.sh history

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
./monitor-memory.sh --help
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–∞ –ø–∞–º—è—Ç–∏

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç x-ui –ø—Ä–∏ **80%** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–º Xray.

–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä–æ–≥:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ä–æ–≥ 70%
MEMORY_THRESHOLD=70 sudo ./monitor-memory.sh monitor

# –ò–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
export MEMORY_THRESHOLD=70
sudo -E ./monitor-memory.sh monitor
```

---

## ‚öôÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –í–∞—Ä–∏–∞–Ω—Ç 1: Crontab (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±)

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–∞–º—è—Ç—å –∫–∞–∂–¥—ã–µ **5 –º–∏–Ω—É—Ç**:

```bash
# –û—Ç–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä crontab
sudo crontab -e

# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É:
*/5 * * * * /home/user/x-ui-settings-update/monitor-memory.sh monitor >> /var/log/x-ui-memory-monitor.log 2>&1
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `*/5 * * * *` - –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- `>> /var/log/x-ui-memory-monitor.log 2>&1` - –ª–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –≤ —Ñ–∞–π–ª

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ cron
sudo crontab -l

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
sudo tail -f /var/log/x-ui-memory-monitor.log
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Systemd Timer (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–°–æ–∑–¥–∞—Ç—å systemd service –∏ timer –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

#### –°–æ–∑–¥–∞—Ç—å service —Ñ–∞–π–ª

```bash
sudo nano /etc/systemd/system/x-ui-memory-monitor.service
```

–í—Å—Ç–∞–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:

```ini
[Unit]
Description=X-UI Memory Monitor
After=x-ui.service
Requires=x-ui.service

[Service]
Type=oneshot
ExecStart=/home/user/x-ui-settings-update/monitor-memory.sh monitor
StandardOutput=journal
StandardError=journal
Environment="MEMORY_THRESHOLD=80"

[Install]
WantedBy=multi-user.target
```

#### –°–æ–∑–¥–∞—Ç—å timer —Ñ–∞–π–ª

```bash
sudo nano /etc/systemd/system/x-ui-memory-monitor.timer
```

–í—Å—Ç–∞–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:

```ini
[Unit]
Description=X-UI Memory Monitor Timer
Requires=x-ui-memory-monitor.service

[Timer]
# –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
OnBootSec=2min
OnUnitActiveSec=5min
AccuracySec=1s

[Install]
WantedBy=timers.target
```

#### –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å timer

```bash
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å systemd
sudo systemctl daemon-reload

# –í–∫–ª—é—á–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å timer
sudo systemctl enable x-ui-memory-monitor.timer
sudo systemctl start x-ui-memory-monitor.timer

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo systemctl status x-ui-memory-monitor.timer

# –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—É—Å–∫–∏
sudo systemctl list-timers x-ui-memory-monitor.timer
```

#### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ systemd

```bash
# –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
sudo journalctl -u x-ui-memory-monitor.service -f

# –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 –∑–∞–ø–∏—Å–µ–π
sudo journalctl -u x-ui-memory-monitor.service -n 50

# –õ–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
sudo journalctl -u x-ui-memory-monitor.service --since "1 hour ago"
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
# –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–º—è—Ç–∏
sudo ./monitor-memory.sh status

# –ò—Å—Ç–æ—Ä–∏—è —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤
./monitor-memory.sh history
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ –∏—Å—Ç–æ—Ä–∏–∏:**
```
=== Restart History ===
Last 10 restarts:
----------------------------------------
Timestamp              Memory
----------------------------------------
2025-12-07 14:23:15   820MB 82%
2025-12-07 16:45:32   950MB 95%
2025-12-07 19:12:08   780MB 78%
----------------------------------------

Restarts in last hour: 0/6
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∞
sudo tail -f /var/log/x-ui-memory-monitor.log

# –ü–æ–∏—Å–∫ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤
sudo grep "Memory threshold exceeded" /var/log/x-ui-memory-monitor.log

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
sudo grep "ERROR" /var/log/x-ui-memory-monitor.log
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

–°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|-----------|----------|--------------|
| `MEMORY_THRESHOLD` | –ü–æ—Ä–æ–≥ –ø–∞–º—è—Ç–∏ –≤ % | 80 |
| `MIN_RESTART_INTERVAL` | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Ä–µ—Å—Ç–∞—Ä—Ç–∞–º–∏ (—Å–µ–∫—É–Ω–¥—ã) | 300 (5 –º–∏–Ω—É—Ç) |
| `MAX_RESTARTS_PER_HOUR` | –ú–∞–∫—Å–∏–º—É–º —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤ –≤ —á–∞—Å | 6 |

### –ü—Ä–∏–º–µ—Ä: –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ 60% –ø–∞–º—è—Ç–∏, –Ω–æ –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 10 –º–∏–Ω—É—Ç
MEMORY_THRESHOLD=60 MIN_RESTART_INTERVAL=600 sudo ./monitor-memory.sh monitor
```

### –ü—Ä–∏–º–µ—Ä: –ú–µ–Ω–µ–µ —á–∞—Å—Ç—ã–µ —Ä–µ—Å—Ç–∞—Ä—Ç—ã

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ 90% –ø–∞–º—è—Ç–∏, –º–∞–∫—Å–∏–º—É–º 3 —Ä–∞–∑–∞ –≤ —á–∞—Å
MEMORY_THRESHOLD=90 MAX_RESTARTS_PER_HOUR=3 sudo ./monitor-memory.sh monitor
```

---

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç restart-loop

–°–∫—Ä–∏–ø—Ç –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∑–∞—â–∏—Ç—É –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤:

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Ä–µ—Å—Ç–∞—Ä—Ç–∞–º–∏**: 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
2. **–ú–∞–∫—Å–∏–º—É–º —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤ –≤ —á–∞—Å**: 6 —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤
3. **Lock-—Ñ–∞–π–ª**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–ø–∏–π

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤:

```
[ERROR] 2025-12-07 14:30:00 - Restart limit reached: 6 restarts in the last hour
[ERROR] 2025-12-07 14:30:00 - Maximum allowed: 6 per hour
[ERROR] 2025-12-07 14:30:00 - Skipping restart to prevent restart loop
[ERROR] 2025-12-07 14:30:00 - Please check for underlying issues causing frequent restarts
```

**–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö —Ä–µ—Å—Ç–∞—Ä—Ç–∞—Ö:**

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ x-ui: `sudo journalctl -u x-ui -n 100`
2. –£–≤–µ–ª–∏—á–∏—Ç—å –ø–∞–º—è—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Dokodemo (—É–º–µ–Ω—å—à–∏—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—é)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: `sudo ss -s`

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–∏–º—É–ª—è—Ü–∏—è –≤—ã—Å–æ–∫–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏

**‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï**: –í—ã–ø–æ–ª–Ω—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ!

```bash
# –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥ –¥–æ 10% –¥–ª—è —Ç–µ—Å—Ç–∞
MEMORY_THRESHOLD=10 sudo ./monitor-memory.sh monitor

# –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
# [WARN] Memory threshold exceeded: XX% >= 10%
# [WARN] Attempting to recover by restarting x-ui service...
# [SUCCESS] Memory recovery completed successfully
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:**
   ```bash
   sudo ./monitor-memory.sh status
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä—É—á–Ω—É—é:**
   ```bash
   sudo ./monitor-memory.sh monitor
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å cron/systemd:**
   ```bash
   # –î–ª—è cron
   sudo crontab -l

   # –î–ª—è systemd
   sudo systemctl status x-ui-memory-monitor.timer
   ```

4. **–ü–æ–¥–æ–∂–¥–∞—Ç—å 5-10 –º–∏–Ω—É—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
   ```bash
   sudo tail -20 /var/log/x-ui-memory-monitor.log
   ```

---

## üìà –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

### –î–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö VPS (1-2 GB RAM)

```bash
# –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
MEMORY_THRESHOLD=70 sudo ./monitor-memory.sh monitor

# –í crontab: –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã
*/3 * * * * /home/user/x-ui-settings-update/monitor-memory.sh monitor
```

### –î–ª—è —Å—Ä–µ–¥–Ω–∏—Ö VPS (4-8 GB RAM)

```bash
# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
MEMORY_THRESHOLD=80 sudo ./monitor-memory.sh monitor

# –í crontab: –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
*/5 * * * * /home/user/x-ui-settings-update/monitor-memory.sh monitor
```

### –î–ª—è –±–æ–ª—å—à–∏—Ö VPS (16+ GB RAM)

```bash
# –ú–µ–Ω–µ–µ —á–∞—Å—Ç—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
MEMORY_THRESHOLD=85 sudo ./monitor-memory.sh monitor

# –í crontab: –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
*/10 * * * * /home/user/x-ui-settings-update/monitor-memory.sh monitor
```

---

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å top –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–æ –ø–∞–º—è—Ç–∏
ps aux --sort=-%mem | head -20

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–º xray
ps -p $(pgrep xray) -o pid,user,%mem,%cpu,cmd

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–º—è—Ç–∏
cat /proc/$(pgrep xray)/status | grep -E "VmSize|VmRSS|VmData"
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

```bash
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
ss -s

# –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç—É 443 (dokodemo)
ss -tn state established '( dport = :443 or sport = :443 )' | wc -l

# –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è xray
lsof -i -a -p $(pgrep xray) | wc -l
```

---

## ‚ùì –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (FAQ)

### Q: –ë—É–¥–µ—Ç –ª–∏ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å—Å—è —Å–≤—è–∑—å –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ?

**A:** –ù–µ—Ç, —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **graceful restart** (`systemctl restart`), –∫–æ—Ç–æ—Ä—ã–π:
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SIGTERM –ø—Ä–æ—Ü–µ—Å—Å—É –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- –î–∞–µ—Ç –≤—Ä–µ–º—è –Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ó–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 1-2 —Å–µ–∫—É–Ω–¥—ã

### Q: –ö–∞–∫ —á–∞—Å—Ç–æ –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥?

**A:** –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ **5 –º–∏–Ω—É—Ç** –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ –º–µ–∂–¥—É –±—ã—Å—Ç—Ä–æ–π —Ä–µ–∞–∫—Ü–∏–µ–π –∏ –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ —Å–∏—Å—Ç–µ–º—É.

### Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ —Ä–µ—Å—Ç–∞—Ä—Ç—ã –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ?

**A:**
1. –£–≤–µ–ª–∏—á–∏—Ç—å –ø–∞–º—è—Ç—å VPS
2. –£–º–µ–Ω—å—à–∏—Ç—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ (downgrade —Å level-2 –Ω–∞ level-1)
3. –£–≤–µ–ª–∏—á–∏—Ç—å `MEMORY_THRESHOLD` –¥–æ 85-90%
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
5. –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–ª–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–æ–≤

### Q: –ú–æ–∂–Ω–æ –ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –±–µ–∑ root?

**A:** –ù–µ—Ç, –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ x-ui service –Ω—É–∂–Ω—ã root –ø—Ä–∞–≤–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `sudo`.

### Q: –ö–∞–∫ —É–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥?

**A:**
```bash
# –î–ª—è cron
sudo crontab -e
# –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å monitor-memory.sh

# –î–ª—è systemd
sudo systemctl stop x-ui-memory-monitor.timer
sudo systemctl disable x-ui-memory-monitor.timer
sudo rm /etc/systemd/system/x-ui-memory-monitor.*
sudo systemctl daemon-reload
```

---

## üìã –§–∞–π–ª—ã –∏ –ª–æ–≥–∏

| –§–∞–π–ª | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|------|----------|
| –°–∫—Ä–∏–ø—Ç | `/home/user/x-ui-settings-update/monitor-memory.sh` | –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç |
| –õ–æ–≥ —Ñ–∞–π–ª | `/var/log/x-ui-memory-monitor.log` | –õ–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ |
| –ò—Å—Ç–æ—Ä–∏—è | `/var/lib/x-ui-memory-monitor.history` | –ò—Å—Ç–æ—Ä–∏—è —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤ |
| Lock —Ñ–∞–π–ª | `/var/run/x-ui-memory-monitor.lock` | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤ |

---

## üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞

### –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞:**
   ```bash
   ls -l /home/user/x-ui-settings-update/monitor-memory.sh
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: -rwxr-xr-x
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å x-ui service:**
   ```bash
   sudo systemctl status x-ui
   ```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å verbose –≤—ã–≤–æ–¥–æ–º:**
   ```bash
   sudo bash -x /home/user/x-ui-settings-update/monitor-memory.sh monitor
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
   ```bash
   sudo journalctl -u x-ui -n 50
   sudo tail -50 /var/log/x-ui-memory-monitor.log
   ```

### –°–æ–∑–¥–∞—Ç—å Issue:

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–∞–µ—Ç—Å—è, —Å–æ–∑–¥–∞–π—Ç–µ Issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:

https://github.com/alche-my/x-ui-settings-update/issues

–ü—Ä–∏–ª–æ–∂–∏—Ç–µ:
- –í—ã–≤–æ–¥ `monitor-memory.sh status`
- –õ–æ–≥–∏ `/var/log/x-ui-memory-monitor.log`
- –í—ã–≤–æ–¥ `free -h` –∏ `ps aux | grep xray`

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [README Dokodemo Bridge](README-dokodemo-bridge.md)
- [Troubleshooting Dokodemo](TROUBLESHOOTING-dokodemo.md)
- [–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç](diagnose-dokodemo-bridge.sh)
- [X-UI Tuning](x-ui-tuning/README.md)

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

- [ ] –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫: `sudo ./monitor-memory.sh status`
- [ ] Cron/Systemd –Ω–∞—Å—Ç—Ä–æ–µ–Ω: `sudo crontab -l` –∏–ª–∏ `sudo systemctl status x-ui-memory-monitor.timer`
- [ ] –õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è: `sudo tail -f /var/log/x-ui-memory-monitor.log`
- [ ] –ò—Å—Ç–æ—Ä–∏—è —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç: `./monitor-memory.sh history`
- [ ] x-ui service —Ä–∞–±–æ—Ç–∞–µ—Ç: `sudo systemctl status x-ui`

**üéâ –ì–æ—Ç–æ–≤–æ! –í–∞—à Dokodemo-—Å–µ—Ä–≤–µ—Ä —Ç–µ–ø–µ—Ä—å –∑–∞—â–∏—â–µ–Ω –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –ø–∞–º—è—Ç–∏!**
